#pragma once

#include <array>
#include <string>
#include "ncurses.h"

#include "IKeyboardInputObserver.hpp"
#include "PlayerCharacter.hpp"
#include "Window.hpp"
#include "Tile.hpp"

class PlayerController : public IKeyboardInputObserver {
public:
    PlayerController(Window& window) :
        _window{window}
    {
        _window.redrawMap(PlayerCharacter {0, 0}, stringToMap(MAP));
    }

    void onKeyPressed(int ch) override {
        switch ( ch ) {

        case KEY_UP:
            if ( y > 0 )
            --y;
            break;

        case KEY_DOWN:
            if ( y < rows - 1 )
            ++y;
            break;

        case KEY_LEFT:
            if ( x > 0 )
            --x;
            break;

        case KEY_RIGHT:
            if ( x < cols - 1)
            ++x;
            break;
        }

        _window.redrawMap(PlayerCharacter {x, y}, stringToMap(MAP));
    }

private:
    Window& _window;
    const unsigned rows  = 25;
    const unsigned cols   = 80;
    unsigned x = 0;
    unsigned y = 0;

    const std::array<std::string, 25> MAP {
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................######..........................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................",
        "................................................................................"
    };

    std::array<std::array<Tile, 80>, 25> stringToMap(const std::array<std::string, 25>& rawMap) {
        std::array<std::array<Tile, 80>, 25> map {};
        for(std::size_t posY = 0; posY < 25; ++posY) {
            for(std::size_t posX = 0; posX < 80; ++posX) {
                if (rawMap[posY][posX] == '.')
                    map[posY][posX] = Tile::Dirt;
                if (rawMap[posY][posX] == '#')
                    map[posY][posX] = Tile::Wall;
            }
        }

        return map;
    }
};